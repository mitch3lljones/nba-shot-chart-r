---
---
title: "R Notebook for NBA Shot Chart"
---

# This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook for Making NBA Shot Charts.

# Data Collection, Cleaning and Function Declarations

We will need to import the required libraries for this project, done below.
```{r}
library(tidyverse)
library(hexbin)
library(jsonlite)
library(httr)
library(scales)
library(prismatic)
library(extrafont)
library(cowplot)
```

Since the libraries are now imported, we will need to make functions to get the NBA player data and format it so we can work with it. Before we can get the data, we'll need to extract the header information for [NBA Stats](stats.nba.com). The following code is taken from [here](https://pastebin.com/EvYCU6q3).
```{r}
headers <- c(
  `Connection` = 'keep-alive',
  `Accept` = 'application/json, text/plain, */*',
  `x-nba-stats-token` = 'true',
  `X-NewRelic-ID` = 'VQECWF5UChAHUlNTBwgBVw==',
  `User-Agent` = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36',
  `x-nba-stats-origin` = 'stats',
  `Sec-Fetch-Site` = 'same-origin',
  `Sec-Fetch-Mode` = 'cors',
  `Referer` = 'https://stats.nba.com/players/leaguedashplayerbiostats/',
  `Accept-Encoding` = 'gzip, deflate, br',
  `Accept-Language` = 'en-US,en;q=0.9'
)
```

Now that we have the header, we can start to get the data. First, we will need to get the URL from which we will pull our data.
```{r}
url <- "http://stats.nba.com/stats/commonallplayers?LeagueID=00&Season=2019-20&IsOnlyCurrentSeason=0"
```

Next, we'll need to use the headers and put the info into a dataframe so we can use it. This dataframe contains all NBA players from 1946-2019.
```{r}
request <- GET(url, add_headers(headers))

players_data = fromJSON(content(request, as = "text"))
players = as_tibble(data.frame(players_data$resultSets$rowSet[[1]], stringsAsFactors = FALSE))
names(players) = tolower(players_data$resultSets$headers[[1]])
```

If you examine the dataframe, the columns person_id, rosterstatus, from_year, to_year, and team_id are chr's. We need all but rosterstatus as numbers so we'll convert them below. Roster status should be a logical value and so we will do this below as well.
```{r}
players <- mutate(players,
                 person_id = as.numeric(person_id),
                 rosterstatus = as.logical(as.numeric(rosterstatus)),
                 from_year = as.numeric(from_year),
                 to_year = as.numeric(to_year),
                 team_id = as.numeric(team_id)
)
```

The last and first names of the players are in one column seperated by a comma. We are split this data and put the first and last name of the players in the new display_first_last column.
```{r}
players$name = sapply(players$display_last_comma_first, function(s) {
  paste(rev(strsplit(s, ", ")[[1]]), collapse = " ")
})
```


The NBA has only been tracking shot location and making the data available since 1996. We will convert years before the start of the 2017 season to have the year 2016.
```{r}
if (Sys.Date() <= as.Date("2017-10-20")) {
  players = mutate(players, to_year = pmin(to_year, 2016))
}
```

Next, we need to put the data for the first and last season the player has data from in one column.
```{r}
first_year_of_data = 1996
last_year_of_data = max(players$to_year)
season_strings = paste(first_year_of_data:last_year_of_data,
                       substr(first_year_of_data:last_year_of_data + 1, 3, 4),
                       sep = "-")
names(season_strings) = first_year_of_data:last_year_of_data
```

Now that we have the players and the data that are available for them, we can get rid of the players who we do not have data for. We will put these players info into the available_players data frame. We will also put the names of the players and resolve any duplicate name entries. AFter we resolve any name duplicates, we will format the last few things in the dataframe.
```{r}
available_players = filter(players, to_year >= first_year_of_data)

names_table = table(available_players$name)
dupe_names = names(names_table[which(names_table > 1)])

available_players$name[available_players$name %in% dupe_names] = paste(
  available_players$name[available_players$name %in% dupe_names],
  available_players$person_id[available_players$name %in% dupe_names]
)

available_players$lower_name = tolower(available_players$name)
available_players = arrange(available_players, lower_name)
```

Lastly, we will make two functions. One to find the player by name and another to find them by ID.
```{r}
find_player_by_name = function(n) {
  filter(available_players, lower_name == tolower(n))
}

find_player_id_by_name = function(n) {
  find_player_by_name(n)$person_id
}
```

## Drawing the Shot Chart

First, we need to create a function to draw circle points for us.
```{r}
circle_points = function(center = c(0, 0), radius = 1, npoints = 360) {
  angles = seq(0, 2 * pi, length.out = npoints)
  return(data_frame(x = center[1] + radius * cos(angles),
                    y = center[2] + radius * sin(angles)))
}
```

Next, we need to initialize our variables for our chart. These include the chart height and width as well as the dimensions of the basketball hoop, key, backboard, and three point line.
```{r}
width = 50
height = 94 / 2
key_height = 19
inner_key_width = 12
outer_key_width = 16
backboard_width = 6
backboard_offset = 4
neck_length = 0.5
hoop_radius = 0.75
hoop_center_y = backboard_offset + neck_length + hoop_radius
three_point_radius = 23.75
three_point_side_radius = 22
three_point_side_height = 14
```

We will also set up two themes for the court: light and dark.
```{r}
court_themes = list(
  light = list(
    court = 'floralwhite',
    lines = '#999999',
    text = '#222222',
    made = '#00bfc4',
    missed = '#f8766d',
    hex_border_size = 1,
    hex_border_color = "#000000"
  ),
  dark = list(
    court = '#000004',
    lines = '#999999',
    text = '#f0f0f0',
    made = '#00bfc4',
    missed = '#f8766d',
    hex_border_size = 0,
    hex_border_color = "#000000"
  )
)
```

Now, we can add our function to plot the court.
```{r}
plot_court = function(court_theme = court_themes$light, use_short_three = FALSE) {
  # Check if the three point line is not NBA regulation.
  if (use_short_three) {
    three_point_radius = 22
    three_point_side_height = 0
  }
  
  # Make a data frame for the court points perimeter
  court_points = data_frame(
    x = c(width / 2, width / 2, -width / 2, -width / 2, width / 2),
    y = c(height, 0, 0, height, height),
    desc = "perimeter"
  )
  
  # Add the outer key dimensions to the data frame
  court_points = bind_rows(court_points , data_frame(
    x = c(outer_key_width / 2, outer_key_width / 2, -outer_key_width / 2, -outer_key_width / 2),
    y = c(0, key_height, key_height, 0),
    desc = "outer_key"
  ))
  
  # Add the backboard to the data frame
  court_points = bind_rows(court_points , data_frame(
    x = c(-backboard_width / 2, backboard_width / 2),
    y = c(backboard_offset, backboard_offset),
    desc = "backboard"
  ))
  
  court_points = bind_rows(court_points , data_frame(
    x = c(0, 0), y = c(backboard_offset, backboard_offset + neck_length), desc = "neck"
  ))
  
  # Make the foul circle
  foul_circle = circle_points(center = c(0, key_height), radius = inner_key_width / 2)
  
  foul_circle_top = filter(foul_circle, y > key_height) %>%
    mutate(desc = "foul_circle_top")
  
  foul_circle_bottom = filter(foul_circle, y < key_height) %>%
    mutate(
      angle = atan((y - key_height) / x) * 180 / pi,
      angle_group = floor((angle - 5.625) / 11.25),
      desc = paste0("foul_circle_bottom_", angle_group)
    ) %>%
    filter(angle_group %% 2 == 0) %>%
    select(x, y, desc)
  
  # Make the basketball hoop
  hoop = circle_points(center = c(0, hoop_center_y), radius = hoop_radius) %>%
    mutate(desc = "hoop")
  
  # Make the restricted area
  restricted = circle_points(center = c(0, hoop_center_y), radius = 4) %>%
    filter(y >= hoop_center_y) %>%
    mutate(desc = "restricted")
  
  # Make the three point circle and line
  three_point_circle = circle_points(center = c(0, hoop_center_y), radius = three_point_radius) %>%
    filter(y >= three_point_side_height, y >= hoop_center_y)
  
  three_point_line = data_frame(
    x = c(three_point_side_radius, three_point_side_radius, three_point_circle$x, -three_point_side_radius, -three_point_side_radius),
    y = c(0, three_point_side_height, three_point_circle$y, three_point_side_height, 0),
    desc = "three_point_line"
  )
  
  # Add all of the dimensions to the dataframe 
  court_points = bind_rows(
    court_points,
    foul_circle_top,
    foul_circle_bottom,
    hoop,
    restricted,
    three_point_line
  )
  
  # Put the new version of court_points into court_points
  court_points <- court_points
  
  # Set up the court plot and display it.
  ggplot() +
    geom_path(
      data = court_points,
      aes(x = x, y = y, group = desc),
      color = court_theme$lines
    ) +
    coord_fixed(ylim = c(0, 45), xlim = c(-25, 25)) +
    theme_minimal(base_size = 22) +
    theme(
      text = element_text(color = court_theme$text),
      plot.background = element_rect(fill = 'floralwhite', color = 'floralwhite'),
      panel.background = element_rect(fill = court_theme$court, color = court_theme$court),
      panel.grid = element_blank(),
      panel.border = element_blank(),
      axis.text = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      legend.background = element_rect(fill = court_theme$court, color = court_theme$court),
      legend.margin = margin(-1, 0, 0, 0, unit = "lines"),
      legend.position = "bottom",
      legend.key = element_blank(),
      legend.text = element_text(size = rel(1.0))
    )
}
```

The court plotting function is finished, let's see what it looks like.
```{r}
plot_court(court_themes$light)
```
